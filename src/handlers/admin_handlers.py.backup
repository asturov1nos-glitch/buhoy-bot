from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.fsm.context import FSMContext
from aiogram.utils.keyboard import InlineKeyboardBuilder
import asyncio
from aiogram.filters import StateFilter  # –î–æ–±–∞–≤—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É –≤ –Ω–∞—á–∞–ª–æ

from src.config import config
from src.database import Database
from src.keyboards import *
from src.states import AddCocktail, EditCocktail
from src.filters import IsAdminFilter
from src.s3_storage import s3_storage

router = Router()
router.message.filter(IsAdminFilter())
router.callback_query.filter(IsAdminFilter())

# ========== –ê–î–ú–ò–ù –ú–ï–ù–Æ ==========
@router.message(F.text == "üë§ –í –º–µ–Ω—é")
async def back_to_main_menu(message: Message):
    await message.answer(
        "üç∏ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç —Å —Ä–µ—Ü–µ–ø—Ç–∞–º–∏ –∫–æ–∫—Ç–µ–π–ª–µ–π!\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=main_menu()
    )

@router.message(F.text == "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
async def show_statistics(message: Message):
    count = await Database.get_cocktails_count()
    backup_info = await s3_storage.get_backup_info()
    
    text = (
        f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞:</b>\n\n"
        f"‚Ä¢ –ö–æ–∫—Ç–µ–π–ª–µ–π –≤ –±–∞–∑–µ: <b>{count}</b>\n"
        f"‚Ä¢ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: <b>{len(config.ADMIN_IDS)}</b>\n"
    )
    
    if backup_info:
        from datetime import datetime
        last_backup = backup_info['last_modified']
        if isinstance(last_backup, str):
            text += f"‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø: <b>{last_backup}</b>\n"
        else:
            text += f"‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø: <b>{last_backup.strftime('%Y-%m-%d %H:%M')}</b>\n"
        text += f"‚Ä¢ –†–∞–∑–º–µ—Ä –±—ç–∫–∞–ø–∞: <b>{backup_info['size'] // 1024} KB</b>\n"
    else:
        text += "‚Ä¢ –ë—ç–∫–∞–ø –≤ S3: <b>–Ω–µ –Ω–∞–π–¥–µ–Ω</b>\n"
    
    if s3_storage.is_configured():
        text += "‚Ä¢ S3 —Ö—Ä–∞–Ω–∏–ª–∏—â–µ: <b>–ø–æ–¥–∫–ª—é—á–µ–Ω–æ ‚úÖ</b>"
    else:
        text += "‚Ä¢ S3 —Ö—Ä–∞–Ω–∏–ª–∏—â–µ: <b>–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ ‚ùå</b>\n<i>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ S3_* –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</i>"
    
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="‚òÅÔ∏è –°–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø", callback_data="make_backup"),
        InlineKeyboardButton(text="üì• –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å", callback_data="restore_backup")
    )
    builder.row(
        InlineKeyboardButton(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É", callback_data="refresh_stats")
    )
    
    await message.answer(text, parse_mode="HTML", reply_markup=builder.as_markup())

# ========== S3 –ë–≠–ö–ê–ü–´ ==========
@router.callback_query(F.data == "make_backup")
async def manual_backup_callback(callback: CallbackQuery):
    await callback.answer("–°–æ–∑–¥–∞—é –±—ç–∫–∞–ø –≤ S3...")
    
    success = await s3_storage.upload_backup(comment="–†—É—á–Ω–æ–π –±—ç–∫–∞–ø –∏–∑ –∞–¥–º–∏–Ω–∫–∏")
    
    if success:
        await callback.message.answer("‚úÖ –ë—ç–∫–∞–ø —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –≤ S3!")
    else:
        await callback.message.answer(
            "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞.\n"
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n"
            "1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ S3 –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è\n"
            "2. –ß—Ç–æ S3 –±–∞–∫–µ—Ç 'cocktail-bot-backups' —Å—É—â–µ—Å—Ç–≤—É–µ—Ç\n"
            "3. –ö–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–∞ S3 –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã"
        )

@router.callback_query(F.data == "restore_backup")
async def restore_backup_callback(callback: CallbackQuery):
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="‚úÖ –î–∞, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å", callback_data="confirm_restore"),
        InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_restore")
    )
    
    backup_info = await s3_storage.get_backup_info()
    
    if backup_info:
        text = (
            "‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ!</b>\n\n"
            "–¢–µ–∫—É—â–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç <b>–ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–∞</b> –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –±—ç–∫–∞–ø–∞.\n"
            "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!\n\n"
            f"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—ç–∫–∞–ø–µ:\n"
            f"‚Ä¢ –†–∞–∑–º–µ—Ä: {backup_info['size'] // 1024} KB\n"
            f"‚Ä¢ –í—Ä–µ–º—è: {backup_info['last_modified'].strftime('%Y-%m-%d %H:%M') if hasattr(backup_info['last_modified'], 'strftime') else backup_info['last_modified']}"
        )
    else:
        text = "‚ùå –ë—ç–∫–∞–ø –≤ S3 –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        builder = InlineKeyboardBuilder()
        builder.row(InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="back_to_stats"))
    
    await callback.message.answer(text, parse_mode="HTML", reply_markup=builder.as_markup())
    await callback.answer()

@router.callback_query(F.data == "confirm_restore")
async def confirm_restore_callback(callback: CallbackQuery):
    await callback.answer("–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –±–∞–∑—É –∏–∑ S3...")
    
    success = await s3_storage.download_backup()
    
    if success:
        await callback.message.answer(
            "‚úÖ –ë–∞–∑–∞ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ S3!\n"
            "–î–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π /start\n\n"
            "<i>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –±–∞–∑–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</i>",
            parse_mode="HTML"
        )
    else:
        await callback.message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–∑—É –∏–∑ S3.\n"
            "–í–æ–∑–º–æ–∂–Ω–æ, –±—ç–∫–∞–ø –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω."
        )

@router.callback_query(F.data == "cancel_restore")
async def cancel_restore_callback(callback: CallbackQuery):
    await callback.message.delete()
    await callback.answer("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ")

@router.callback_query(F.data == "refresh_stats")
async def refresh_stats_callback(callback: CallbackQuery):
    await callback.answer("–û–±–Ω–æ–≤–ª—è—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...")
    await show_statistics(callback.message)

@router.callback_query(F.data == "back_to_stats")
async def back_to_stats_callback(callback: CallbackQuery):
    await callback.message.delete()
    await show_statistics(callback.message)

# ========== –î–û–ë–ê–í–õ–ï–ù–ò–ï –ö–û–ö–¢–ï–ô–õ–Ø ==========
@router.message(F.text == "‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–∫—Ç–µ–π–ª—å")
async def add_cocktail_start(message: Message, state: FSMContext):
    await message.answer(
        "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–∫—Ç–µ–π–ª—è:\n"
        "<i>–ü—Ä–∏–º–µ—Ä: –ú–æ—Ö–∏—Ç–æ, –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞, –î–∞–π–∫–∏—Ä–∏</i>",
        parse_mode="HTML",
        reply_markup=cancel_keyboard()
    )
    await state.set_state(AddCocktail.name)

@router.message(AddCocktail.name)
async def process_name(message: Message, state: FSMContext):
    if len(message.text) > 100:
        await message.answer("–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å 100 —Å–∏–º–≤–æ–ª–æ–≤). –í–≤–µ–¥–∏—Ç–µ —Å–Ω–æ–≤–∞:")
        return
    
    await state.update_data(name=message.text)
    await message.answer(
        "–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–∫—Ç–µ–π–ª—è (–º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å):",
        reply_markup=cancel_keyboard()
    )
    await state.set_state(AddCocktail.description)

@router.message(AddCocktail.description)
async def process_description(message: Message, state: FSMContext):
    await state.update_data(description=message.text)
    await message.answer(
        "–í–≤–µ–¥–∏—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        "<code>–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ\n–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</code>\n\n"
        "<i>–ü—Ä–∏–º–µ—Ä:\n—Ä–æ–º: 50 –º–ª\n–ª–∞–π–º: 1/2 —à—Ç\n–º—è—Ç–∞: 6 –ª–∏—Å—Ç—å–µ–≤</i>",
        parse_mode="HTML",
        reply_markup=cancel_keyboard()
    )
    await state.set_state(AddCocktail.ingredients)

@router.message(AddCocktail.ingredients)
async def process_ingredients(message: Message, state: FSMContext):
    try:
        ingredients = {}
        lines = [line.strip() for line in message.text.split('\n') if line.strip()]
        
        for line in lines:
            if ':' in line:
                ingredient, amount = line.split(':', 1)
                ingredients[ingredient.strip()] = amount.strip()
            else:
                # –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –ø—Ä–æ—Å–∏–º –∏—Å–ø—Ä–∞–≤–∏—Ç—å
                await message.answer(
                    "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ '–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ'\n"
                    "–í–≤–µ–¥–∏—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã —Å–Ω–æ–≤–∞:"
                )
                return
        
        if not ingredients:
            await message.answer("‚ùå –ù–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤. –í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω:")
            return
        
        await state.update_data(ingredients=ingredients)
        await message.answer(
            "–í–≤–µ–¥–∏—Ç–µ —Ä–µ—Ü–µ–ø—Ç –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è:",
            reply_markup=cancel_keyboard()
        )
        await state.set_state(AddCocktail.recipe)
        
    except Exception as e:
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞: {e}. –í–≤–µ–¥–∏—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã —Å–Ω–æ–≤–∞:")
        return

@router.message(AddCocktail.recipe)
async def process_recipe(message: Message, state: FSMContext):
    await state.update_data(recipe=message.text)
    await message.answer(
        "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:\n"
        "<i>–ü—Ä–∏–º–µ—Ä: –æ—Å–≤–µ–∂–∞—é—â–∏–π, –ª–µ—Ç–Ω–∏–π, —Ä–æ–º–æ–≤—ã–π, –∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–π</i>",
        parse_mode="HTML",
        reply_markup=cancel_keyboard()
    )
    await state.set_state(AddCocktail.tags)

@router.message(AddCocktail.tags)
async def process_tags(message: Message, state: FSMContext):
    tags = [tag.strip() for tag in message.text.split(',') if tag.strip()]
    await state.update_data(tags=tags)
    
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="–°–ª–∞–±–æ–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–π (0-15¬∞)", callback_data="strength:10"),
        InlineKeyboardButton(text="–°—Ä–µ–¥–Ω–∏–π (16-25¬∞)", callback_data="strength:20")
    )
    builder.row(
        InlineKeyboardButton(text="–ö—Ä–µ–ø–∫–∏–π (26-40¬∞)", callback_data="strength:35"),
        InlineKeyboardButton(text="–ë–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–π", callback_data="strength:0")
    )
    
    await message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–µ–ø–æ—Å—Ç—å –∫–æ–∫—Ç–µ–π–ª—è:",
        reply_markup=builder.as_markup()
    )
    await state.set_state(AddCocktail.strength)

@router.callback_query(AddCocktail.strength, F.data.startswith("strength:"))
async def process_strength(callback: CallbackQuery, state: FSMContext):
    strength = int(callback.data.split(":")[1])
    await state.update_data(strength=strength)
    
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="–õ–µ–≥–∫–æ", callback_data="difficulty:–ª–µ–≥–∫–æ"),
        InlineKeyboardButton(text="–°—Ä–µ–¥–Ω–µ", callback_data="difficulty:—Å—Ä–µ–¥–Ω–µ")
    )
    builder.row(
        InlineKeyboardButton(text="–°–ª–æ–∂–Ω–æ", callback_data="difficulty:—Å–ª–æ–∂–Ω–æ")
    )
    
    await callback.message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è:",
        reply_markup=builder.as_markup()
    )
    await state.set_state(AddCocktail.difficulty)
    await callback.answer()

@router.callback_query(AddCocktail.difficulty, F.data.startswith("difficulty:"))
async def process_difficulty(callback: CallbackQuery, state: FSMContext):
    difficulty = callback.data.split(":")[1]
    await state.update_data(difficulty=difficulty)
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
    data = await state.get_data()
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    preview = (
        f"<b>üìã –ü–†–ï–î–ü–†–û–°–ú–û–¢–† –ö–û–ö–¢–ï–ô–õ–Ø</b>\n\n"
        f"<b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> {data['name']}\n"
        f"<b>–û–ø–∏—Å–∞–Ω–∏–µ:</b> {data.get('description', '–Ω–µ—Ç')}\n"
        f"<b>–ö—Ä–µ–ø–æ—Å—Ç—å:</b> {data['strength']}¬∞\n"
        f"<b>–°–ª–æ–∂–Ω–æ—Å—Ç—å:</b> {data['difficulty']}\n"
        f"<b>–¢–µ–≥–∏:</b> {', '.join(data['tags']) if data['tags'] else '–Ω–µ—Ç'}\n\n"
        f"<b>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</b>\n"
    )
    
    for ingredient, amount in data['ingredients'].items():
        preview += f"‚Ä¢ {ingredient}: {amount}\n"
    
    preview += f"\n<b>–†–µ—Ü–µ–ø—Ç:</b>\n{data['recipe']}"
    
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", callback_data="save_cocktail"),
        InlineKeyboardButton(text="‚úèÔ∏è –ò—Å–ø—Ä–∞–≤–∏—Ç—å", callback_data="edit_cocktail_data")
    )
    builder.row(InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_add"))
    
    await callback.message.answer(preview, parse_mode="HTML", reply_markup=builder.as_markup())
    await state.set_state(AddCocktail.confirm)
    await callback.answer()

@router.callback_query(AddCocktail.confirm, F.data == "save_cocktail")
async def save_cocktail(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    
    try:
        cocktail = await Database.add_cocktail(**data)
        
        await callback.message.answer(
            f"‚úÖ –ö–æ–∫—Ç–µ–π–ª—å <b>{cocktail.name}</b> —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!\n"
            f"–í—Å–µ–≥–æ –∫–æ–∫—Ç–µ–π–ª–µ–π –≤ –±–∞–∑–µ: {await Database.get_cocktails_count()}",
            parse_mode="HTML"
        )
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–∫—Ç–µ–π–ª—å
        text = (
            f"<b>{cocktail.name}</b>\n\n"
            f"<i>{cocktail.description or '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</i>\n\n"
            f"<b>–¢–µ–≥–∏:</b> {cocktail.get_tags_text()}\n"
            f"<b>–ö—Ä–µ–ø–æ—Å—Ç—å:</b> {cocktail.strength}¬∞\n"
            f"<b>–°–ª–æ–∂–Ω–æ—Å—Ç—å:</b> {cocktail.difficulty}"
        )
        
        await callback.message.answer(
            text,
            parse_mode="HTML",
            reply_markup=cocktail_detail_keyboard(cocktail.id, is_admin=True)
        )
        
    except Exception as e:
        await callback.message.answer(
            f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: {e}\n"
            "–í–æ–∑–º–æ–∂–Ω–æ, –∫–æ–∫—Ç–µ–π–ª—å —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
        )
    
    await state.clear()
    await callback.answer()

@router.callback_query(AddCocktail.confirm, F.data == "edit_cocktail_data")
async def edit_cocktail_data(callback: CallbackQuery, state: FSMContext):
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="–ù–∞–∑–≤–∞–Ω–∏–µ", callback_data="edit_field:name"),
        InlineKeyboardButton(text="–û–ø–∏—Å–∞–Ω–∏–µ", callback_data="edit_field:description")
    )
    builder.row(
        InlineKeyboardButton(text="–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã", callback_data="edit_field:ingredients"),
        InlineKeyboardButton(text="–†–µ—Ü–µ–ø—Ç", callback_data="edit_field:recipe")
    )
    builder.row(
        InlineKeyboardButton(text="–¢–µ–≥–∏", callback_data="edit_field:tags"),
        InlineKeyboardButton(text="–ö—Ä–µ–ø–æ—Å—Ç—å", callback_data="edit_field:strength")
    )
    builder.row(
        InlineKeyboardButton(text="–°–ª–æ–∂–Ω–æ—Å—Ç—å", callback_data="edit_field:difficulty"),
        InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="back_to_preview")
    )
    
    await callback.message.answer(
        "–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?",
        reply_markup=builder.as_markup()
    )
    await callback.answer()

@router.callback_query(AddCocktail.confirm, F.data.startswith("edit_field:"))
async def edit_specific_field(callback: CallbackQuery, state: FSMContext):
    field = callback.data.split(":")[1]
    
    field_messages = {
        'name': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:',
        'description': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:',
        'ingredients': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:',
        'recipe': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç:',
        'tags': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:',
        'strength': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –∫—Ä–µ–ø–æ—Å—Ç—å (0-40):',
        'difficulty': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å–ª–æ–∂–Ω–æ—Å—Ç—å (–ª–µ–≥–∫–æ/—Å—Ä–µ–¥–Ω–µ/—Å–ª–æ–∂–Ω–æ):'
    }
    
    await state.update_data(editing_field=field)
    await callback.message.answer(field_messages[field])
    await state.set_state(AddCocktail.confirm)  # –û—Å—Ç–∞–µ–º—Å—è –≤ —Ç–æ–º –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    
    await callback.answer()

@router.message(AddCocktail.confirm)
async def process_field_edit(message: Message, state: FSMContext):
    data = await state.get_data()
    field = data.get('editing_field')
    
    if not field:
        return
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è
    if field == 'strength':
        try:
            value = int(message.text)
            if not 0 <= value <= 40:
                await message.answer("–ö—Ä–µ–ø–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 0 –¥–æ 40. –í–≤–µ–¥–∏—Ç–µ —Å–Ω–æ–≤–∞:")
                return
        except ValueError:
            await message.answer("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 40:")
            return
    elif field == 'difficulty':
        if message.text not in ['–ª–µ–≥–∫–æ', '—Å—Ä–µ–¥–Ω–µ', '—Å–ª–æ–∂–Ω–æ']:
            await message.answer("–í–≤–µ–¥–∏—Ç–µ '–ª–µ–≥–∫–æ', '—Å—Ä–µ–¥–Ω–µ' –∏–ª–∏ '—Å–ª–æ–∂–Ω–æ':")
            return
        value = message.text
    elif field == 'tags':
        value = [tag.strip() for tag in message.text.split(',') if tag.strip()]
    elif field == 'ingredients':
        value = {}
        lines = [line.strip() for line in message.text.split('\n') if line.strip()]
        for line in lines:
            if ':' in line:
                ingredient, amount = line.split(':', 1)
                value[ingredient.strip()] = amount.strip()
        if not value:
            await message.answer("–ù–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤. –í–≤–µ–¥–∏—Ç–µ —Å–Ω–æ–≤–∞:")
            return
    else:
        value = message.text
    
    data[field] = value
    await state.update_data(**data)
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä—É
    preview = (
        f"<b>üìã –ü–†–ï–î–ü–†–û–°–ú–û–¢–† –ö–û–ö–¢–ï–ô–õ–Ø (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)</b>\n\n"
        f"<b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> {data['name']}\n"
        f"<b>–û–ø–∏—Å–∞–Ω–∏–µ:</b> {data.get('description', '–Ω–µ—Ç')}\n"
        f"<b>–ö—Ä–µ–ø–æ—Å—Ç—å:</b> {data['strength']}¬∞\n"
        f"<b>–°–ª–æ–∂–Ω–æ—Å—Ç—å:</b> {data['difficulty']}\n"
        f"<b>–¢–µ–≥–∏:</b> {', '.join(data['tags']) if data['tags'] else '–Ω–µ—Ç'}\n\n"
        f"<b>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</b>\n"
    )
    
    for ingredient, amount in data['ingredients'].items():
        preview += f"‚Ä¢ {ingredient}: {amount}\n"
    
    preview += f"\n<b>–†–µ—Ü–µ–ø—Ç:</b>\n{data['recipe']}"
    
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", callback_data="save_cocktail"),
        InlineKeyboardButton(text="‚úèÔ∏è –ò—Å–ø—Ä–∞–≤–∏—Ç—å", callback_data="edit_cocktail_data")
    )
    builder.row(InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_add"))
    
    await message.answer(preview, parse_mode="HTML", reply_markup=builder.as_markup())

@router.callback_query(AddCocktail.confirm, F.data == "back_to_preview")
async def back_to_preview(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    
    preview = (
        f"<b>üìã –ü–†–ï–î–ü–†–û–°–ú–û–¢–† –ö–û–ö–¢–ï–ô–õ–Ø</b>\n\n"
        f"<b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> {data['name']}\n"
        f"<b>–û–ø–∏—Å–∞–Ω–∏–µ:</b> {data.get('description', '–Ω–µ—Ç')}\n"
        f"<b>–ö—Ä–µ–ø–æ—Å—Ç—å:</b> {data['strength']}¬∞\n"
        f"<b>–°–ª–æ–∂–Ω–æ—Å—Ç—å:</b> {data['difficulty']}\n"
        f"<b>–¢–µ–≥–∏:</b> {', '.join(data['tags']) if data['tags'] else '–Ω–µ—Ç'}\n\n"
        f"<b>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</b>\n"
    )
    
    for ingredient, amount in data['ingredients'].items():
        preview += f"‚Ä¢ {ingredient}: {amount}\n"
    
    preview += f"\n<b>–†–µ—Ü–µ–ø—Ç:</b>\n{data['recipe']}"
    
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", callback_data="save_cocktail"),
        InlineKeyboardButton(text="‚úèÔ∏è –ò—Å–ø—Ä–∞–≤–∏—Ç—å", callback_data="edit_cocktail_data")
    )
    builder.row(InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_add"))
    
    await callback.message.answer(preview, parse_mode="HTML", reply_markup=builder.as_markup())
    await callback.answer()

@router.callback_query(AddCocktail.confirm, F.data == "cancel_add")
async def cancel_add_cocktail(callback: CallbackQuery, state: FSMContext):
    await state.clear()
    await callback.message.answer("‚ùå –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–∫—Ç–µ–π–ª—è –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    await callback.answer()

# ========== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ö–û–ö–¢–ï–ô–õ–Ø ==========
@router.message(F.text == "üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å")
async def edit_cocktail_start(message: Message, state: FSMContext):
    cocktails = await Database.get_all_cocktails()
    if cocktails:
        await message.answer(
            "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–∫—Ç–µ–π–ª—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:",
            reply_markup=cocktails_list_keyboard(cocktails)
        )
        await state.set_state(EditCocktail.select_cocktail)
    else:
        await message.answer("–í –±–∞–∑–µ –Ω–µ—Ç –∫–æ–∫—Ç–µ–π–ª–µ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")

@router.callback_query(StateFilter(EditCocktail.select_cocktail), F.data.startswith("view:"))
async def select_cocktail_for_edit(callback: CallbackQuery, state: FSMContext):
    cocktail_id = int(callback.data.split(":")[1])
    await state.update_data(cocktail_id=cocktail_id)
    
    cocktail = await Database.get_cocktail_by_id(cocktail_id)
    if not cocktail:
        await callback.answer("–ö–æ–∫—Ç–µ–π–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return
    
    builder = InlineKeyboardBuilder()
    fields = [
        ('–ù–∞–∑–≤–∞–Ω–∏–µ', 'name'),
        ('–û–ø–∏—Å–∞–Ω–∏–µ', 'description'),
        ('–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã', 'ingredients'),
        ('–†–µ—Ü–µ–ø—Ç', 'recipe'),
        ('–¢–µ–≥–∏', 'tags'),
        ('–ö—Ä–µ–ø–æ—Å—Ç—å', 'strength'),
        ('–°–ª–æ–∂–Ω–æ—Å—Ç—å', 'difficulty'),
        ('üîô –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π', 'back')
    ]
    
    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ 2 –≤ —Ä—è–¥
    for i in range(0, len(fields), 2):
        row = fields[i:i+2]
        buttons = []
        for text, field in row:
            if field == 'back':
                buttons.append(InlineKeyboardButton(text=text, callback_data="back_to_list"))
            else:
                buttons.append(InlineKeyboardButton(text=text, callback_data=f"edit_field:{field}"))
        builder.row(*buttons)
    
    await callback.message.answer(
        f"–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –∫–æ–∫—Ç–µ–π–ª–µ <b>{cocktail.name}</b>?",
        parse_mode="HTML",
        reply_markup=builder.as_markup()
    )
    await state.set_state(EditCocktail.select_field)
    await callback.answer()

@router.callback_query(EditCocktail.select_field, F.data.startswith("edit_field:"))
async def select_field_to_edit(callback: CallbackQuery, state: FSMContext):
    field = callback.data.split(":")[1]
    await state.update_data(editing_field=field)
    
    field_messages = {
        'name': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:',
        'description': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:',
        'ingredients': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ":',
        'recipe': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç:',
        'tags': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:',
        'strength': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –∫—Ä–µ–ø–æ—Å—Ç—å (0-40):',
        'difficulty': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å–ª–æ–∂–Ω–æ—Å—Ç—å (–ª–µ–≥–∫–æ/—Å—Ä–µ–¥–Ω–µ/—Å–ª–æ–∂–Ω–æ):'
    }
    
    await callback.message.answer(field_messages[field])
    await state.set_state(EditCocktail.enter_value)
    await callback.answer()

@router.message(EditCocktail.enter_value)
async def process_edit_value(message: Message, state: FSMContext):
    data = await state.get_data()
    cocktail_id = data['cocktail_id']
    field = data['editing_field']
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–ª—è
    if field == 'strength':
        try:
            value = int(message.text)
            if not 0 <= value <= 40:
                await message.answer("–ö—Ä–µ–ø–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 0 –¥–æ 40. –í–≤–µ–¥–∏—Ç–µ —Å–Ω–æ–≤–∞:")
                return
        except ValueError:
            await message.answer("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 40:")
            return
    elif field == 'difficulty':
        if message.text not in ['–ª–µ–≥–∫–æ', '—Å—Ä–µ–¥–Ω–µ', '—Å–ª–æ–∂–Ω–æ']:
            await message.answer("–í–≤–µ–¥–∏—Ç–µ '–ª–µ–≥–∫–æ', '—Å—Ä–µ–¥–Ω–µ' –∏–ª–∏ '—Å–ª–æ–∂–Ω–æ':")
            return
        value = message.text
    elif field == 'tags':
        value = [tag.strip() for tag in message.text.split(',') if tag.strip()]
    elif field == 'ingredients':
        value = {}
        lines = [line.strip() for line in message.text.split('\n') if line.strip()]
        for line in lines:
            if ':' in line:
                ingredient, amount = line.split(':', 1)
                value[ingredient.strip()] = amount.strip()
        if not value:
            await message.answer("–ù–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤. –í–≤–µ–¥–∏—Ç–µ —Å–Ω–æ–≤–∞:")
            return
    else:
        value = message.text
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–∫—Ç–µ–π–ª—å
    cocktail = await Database.update_cocktail(cocktail_id, **{field: value})
    
    if cocktail:
        await message.answer(f"‚úÖ –ö–æ–∫—Ç–µ–π–ª—å <b>{cocktail.name}</b> —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!", parse_mode="HTML")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫–æ–∫—Ç–µ–π–ª—å
        text = (
            f"<b>{cocktail.name}</b>\n\n"
            f"<i>{cocktail.description or '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</i>\n\n"
            f"<b>–¢–µ–≥–∏:</b> {cocktail.get_tags_text()}\n"
            f"<b>–ö—Ä–µ–ø–æ—Å—Ç—å:</b> {cocktail.strength}¬∞\n"
            f"<b>–°–ª–æ–∂–Ω–æ—Å—Ç—å:</b> {cocktail.difficulty}"
        )
        
        await message.answer(
            text,
            parse_mode="HTML",
            reply_markup=cocktail_detail_keyboard(cocktail.id, is_admin=True)
        )
    else:
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–∫—Ç–µ–π–ª—è")
    
    await state.clear()

@router.callback_query(EditCocktail.select_field, F.data == "back_to_list")
async def back_to_list_edit(callback: CallbackQuery, state: FSMContext):
    await state.clear()
    cocktails = await Database.get_all_cocktails()
    await callback.message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–∫—Ç–µ–π–ª—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:",
        reply_markup=cocktails_list_keyboard(cocktails)
    )
    await state.set_state(EditCocktail.select_cocktail)
    await callback.answer()

# ========== –£–î–ê–õ–ï–ù–ò–ï –ö–û–ö–¢–ï–ô–õ–Ø ==========
@router.message(F.text == "üóëÔ∏è –£–¥–∞–ª–∏—Ç—å")
async def delete_cocktail_start(message: Message):
    cocktails = await Database.get_all_cocktails()
    if cocktails:
        await message.answer(
            "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–∫—Ç–µ–π–ª—å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:",
            reply_markup=cocktails_list_keyboard(cocktails)
        )
    else:
        await message.answer("–í –±–∞–∑–µ –Ω–µ—Ç –∫–æ–∫—Ç–µ–π–ª–µ–π")

@router.callback_query(F.data.startswith("delete:"))
async def confirm_delete_cocktail(callback: CallbackQuery):
    cocktail_id = int(callback.data.split(":")[1])
    cocktail = await Database.get_cocktail_by_id(cocktail_id)
    
    if cocktail:
        await callback.message.answer(
            f"‚ö†Ô∏è <b>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ</b>\n\n"
            f"–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–∫—Ç–µ–π–ª—å <b>{cocktail.name}</b>?\n"
            f"–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!",
            parse_mode="HTML",
            reply_markup=confirm_delete_keyboard(cocktail_id)
        )
    else:
        await callback.answer("–ö–æ–∫—Ç–µ–π–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    await callback.answer()

@router.callback_query(F.data.startswith("confirm_delete:"))
async def process_delete_cocktail(callback: CallbackQuery):
    cocktail_id = int(callback.data.split(":")[1])
    
    success = await Database.delete_cocktail(cocktail_id)
    
    if success:
        await callback.message.answer("‚úÖ –ö–æ–∫—Ç–µ–π–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!")
    else:
        await callback.message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–∫—Ç–µ–π–ª—è")
    
    await callback.answer()

@router.callback_query(F.data == "cancel_delete")
async def cancel_delete_cocktail(callback: CallbackQuery):
    await callback.message.delete()
    await callback.answer("–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ")

# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–õ–Ø –°–ü–ò–°–ö–û–í ==========
@router.callback_query(F.data == "main_menu")
async def back_to_main_menu_callback(callback: CallbackQuery):
    await callback.message.answer(
        "üç∏ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç —Å —Ä–µ—Ü–µ–ø—Ç–∞–º–∏ –∫–æ–∫—Ç–µ–π–ª–µ–π!\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=main_menu()
    )
    await callback.answer()

@router.callback_query(F.data == "back_to_list")
async def back_to_list_callback(callback: CallbackQuery):
    cocktails = await Database.get_all_cocktails()
    await callback.message.answer(
        f"üìö –í—Å–µ –∫–æ–∫—Ç–µ–π–ª–∏ ({len(cocktails)} —à—Ç.):",
        reply_markup=cocktails_list_keyboard(cocktails)
    )
    await callback.answer()

@router.callback_query(F.data.startswith("page:"))
async def paginate_cocktails(callback: CallbackQuery):
    page = int(callback.data.split(":")[1])
    cocktails = await Database.get_all_cocktails()
    
    await callback.message.edit_reply_markup(
        reply_markup=cocktails_list_keyboard(cocktails, page=page)
    )
    await callback.answer()

# ========== –î–ï–¢–ê–õ–ò –ö–û–ö–¢–ï–ô–õ–Ø (–∞–¥–º–∏–Ω –≤–µ—Ä—Å–∏—è) ==========
@router.callback_query(F.data.startswith("ingr:"))
async def show_ingredients(callback: CallbackQuery):
    cocktail_id = int(callback.data.split(":")[1])
    cocktail = await Database.get_cocktail_by_id(cocktail_id)
    
    if cocktail:
        ingredients_text = cocktail.get_ingredients_text()
        await callback.message.answer(
            f"<b>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –¥–ª—è {cocktail.name}:</b>\n\n{ingredients_text}",
            parse_mode="HTML"
        )
    else:
        await callback.answer("–ö–æ–∫—Ç–µ–π–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    await callback.answer()

@router.callback_query(F.data.startswith("recipe:"))
async def show_recipe(callback: CallbackQuery):
    cocktail_id = int(callback.data.split(":")[1])
    cocktail = await Database.get_cocktail_by_id(cocktail_id)
    
    if cocktail:
        await callback.message.answer(
            f"<b>–†–µ—Ü–µ–ø—Ç {cocktail.name}:</b>\n\n{cocktail.recipe}",
            parse_mode="HTML"
        )
    else:
        await callback.answer("–ö–æ–∫—Ç–µ–π–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    await callback.answer()

@router.callback_query(F.data.startswith("edit:"))
async def edit_specific_cocktail(callback: CallbackQuery):
    cocktail_id = int(callback.data.split(":")[1])
    cocktail = await Database.get_cocktail_by_id(cocktail_id)
    
    if cocktail:
        builder = InlineKeyboardBuilder()
        fields = [
            ('–ù–∞–∑–≤–∞–Ω–∏–µ', 'name'),
            ('–û–ø–∏—Å–∞–Ω–∏–µ', 'description'),
            ('–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã', 'ingredients'),
            ('–†–µ—Ü–µ–ø—Ç', 'recipe'),
            ('–¢–µ–≥–∏', 'tags'),
            ('–ö—Ä–µ–ø–æ—Å—Ç—å', 'strength'),
            ('–°–ª–æ–∂–Ω–æ—Å—Ç—å', 'difficulty'),
            ('üîô –ù–∞–∑–∞–¥', 'back')
        ]
        
        for i in range(0, len(fields), 2):
            row = fields[i:i+2]
            buttons = []
            for text, field in row:
                if field == 'back':
                    buttons.append(InlineKeyboardButton(text=text, callback_data=f"view:{cocktail_id}"))
                else:
                    buttons.append(InlineKeyboardButton(text=text, callback_data=f"edit_existing:{cocktail_id}:{field}"))
            builder.row(*buttons)
        
        await callback.message.answer(
            f"–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –∫–æ–∫—Ç–µ–π–ª–µ <b>{cocktail.name}</b>?",
            parse_mode="HTML",
            reply_markup=builder.as_markup()
        )
    else:
        await callback.answer("–ö–æ–∫—Ç–µ–π–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    await callback.answer()

@router.callback_query(F.data.startswith("edit_existing:"))
async def edit_existing_cocktail_field(callback: CallbackQuery, state: FSMContext):
    _, cocktail_id, field = callback.data.split(":")
    cocktail_id = int(cocktail_id)
    
    await state.update_data(cocktail_id=cocktail_id, editing_field=field)
    
    field_messages = {
        'name': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:',
        'description': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:',
        'ingredients': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ":',
        'recipe': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç:',
        'tags': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:',
        'strength': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –∫—Ä–µ–ø–æ—Å—Ç—å (0-40):',
        'difficulty': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å–ª–æ–∂–Ω–æ—Å—Ç—å (–ª–µ–≥–∫–æ/—Å—Ä–µ–¥–Ω–µ/—Å–ª–æ–∂–Ω–æ):'
    }
    
    await callback.message.answer(field_messages[field])
    await state.set_state(EditCocktail.enter_value)
    await callback.answer()

@router.callback_query(F.data == "random")
async def random_cocktail_callback(callback: CallbackQuery):
    cocktail = await Database.get_random_cocktail()
    if cocktail:
        text = (
            f"<b>{cocktail.name}</b>\n\n"
            f"<i>{cocktail.description or '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</i>\n\n"
            f"<b>–¢–µ–≥–∏:</b> {cocktail.get_tags_text()}\n"
            f"<b>–ö—Ä–µ–ø–æ—Å—Ç—å:</b> {cocktail.strength}¬∞\n"
            f"<b>–°–ª–æ–∂–Ω–æ—Å—Ç—å:</b> {cocktail.difficulty}"
        )
        
        await callback.message.edit_text(
            text,
            parse_mode="HTML",
            reply_markup=cocktail_detail_keyboard(cocktail.id, is_admin=True)
        )
    else:
        await callback.answer("–ö–æ–∫—Ç–µ–π–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç")
    
    await callback.answer()

@router.callback_query(F.data == "cancel")
async def cancel_action(callback: CallbackQuery, state: FSMContext):
    await state.clear()
    await callback.message.answer("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    await callback.message.delete()
    await callback.answer()