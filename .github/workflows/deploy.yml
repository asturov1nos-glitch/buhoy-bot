name: Deploy Cocktail Bot to Yandex Cloud
on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: cr.yandex
  IMAGE_NAME: cocktail-bot
  CONTAINER_NAME: cocktail-bot

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Yandex Cloud CLI
        uses: yc-actions/yc-ccli-setup@v2
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_KEY }}
      
      - name: Create or update container
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          ADMIN_IDS: ${{ secrets.ADMIN_IDS }}
          DB_HOST: localhost
          REDIS_HOST: localhost
        run: |
          # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç (–¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)
          yc serverless container create --name $CONTAINER_NAME 2>/dev/null || true
          
          # –î–µ–ø–ª–æ–∏–º —Ä–µ–≤–∏–∑–∏—é —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
          yc serverless container revision deploy \
            --container-name $CONTAINER_NAME \
            --memory 512MB \
            --cores 1 \
            --execution-timeout 30s \
            --concurrency 8 \
            --service-account-id ${{ secrets.YC_SA_ID }} \
            --environment "BOT_TOKEN=$BOT_TOKEN" \
            --environment "ADMIN_IDS=$ADMIN_IDS" \
            --environment "DB_HOST=$DB_HOST" \
            --environment "REDIS_HOST=$REDIS_HOST" \
            --source-path .
          
          # –ü–æ–ª—É—á–∞–µ–º URL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
          CONTAINER_URL=$(yc serverless container get --name $CONTAINER_NAME --format json | jq -r '.url')
          echo "üöÄ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –ø–æ –∞–¥—Ä–µ—Å—É: $CONTAINER_URL"
          echo "üëâ –ü—Ä–æ–≤–µ—Ä—å –∑–¥–æ—Ä–æ–≤—å–µ: $CONTAINER_URL/health"