name: Deploy Cocktail Bot to Yandex Cloud

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: cr.yandex
  IMAGE_NAME: cocktail-bot

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Yandex Container Registry
        uses: docker/login-action@v3
        with:
          registry: cr.yandex
          username: json_key
          password: ${{ secrets.YC_SA_JSON_KEY }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags:
            - cr.yandex/${{ secrets.YC_REGISTRY_ID }}/cocktail-bot:${{ github.sha }}
            - cr.yandex/${{ secrets.YC_REGISTRY_ID }}/cocktail-bot:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Setup Yandex Cloud CLI
        uses: yc-actions/yc-ccli-setup@v2
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_KEY }}
      
      - name: Deploy to Yandex Cloud Container
        run: |
          # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          yc serverless container create --name cocktail-bot 2>/dev/null || true
          
          # –î–ª—è –ø–µ—Ä–≤–æ–≥–æ –¥–µ–ø–ª–æ—è –∏—Å–ø–æ–ª—å–∑—É–µ–º polling —Ä–µ–∂–∏–º
          # WEBHOOK_URL –ø–æ–∫–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
          yc serverless container revision deploy \
            --container-name cocktail-bot \
            --image cr.yandex/${{ secrets.YC_REGISTRY_ID }}/cocktail-bot:${{ github.sha }} \
            --service-account-id ${{ secrets.YC_SA_ID }} \
            --cores 1 \
            --memory 512MB \
            --concurrency 8 \
            --execution-timeout 30s \
            --environment BOT_TOKEN=${{ secrets.BOT_TOKEN }} \
            --environment ADMIN_IDS=${{ secrets.ADMIN_IDS }} \
            --environment DB_HOST=${{ secrets.DB_HOST }} \
            --environment DB_PORT=${{ secrets.DB_PORT }} \
            --environment DB_NAME=${{ secrets.DB_NAME }} \
            --environment DB_USER=${{ secrets.DB_USER }} \
            --environment DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
            --environment REDIS_HOST=${{ secrets.REDIS_HOST }} \
            --environment REDIS_PORT=${{ secrets.REDIS_PORT }} \
            --environment REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }} \
            --environment PORT=8080
      
      - name: Get container URL
        run: |
          CONTAINER_URL=$(yc serverless container get --name cocktail-bot --format json | jq -r '.url')
          echo "üöÄ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –ø–æ –∞–¥—Ä–µ—Å—É: $CONTAINER_URL"
          echo "üëâ –î–æ–±–∞–≤—å —ç—Ç–æ—Ç URL –≤ GitHub Secrets –∫–∞–∫ WEBHOOK_URL: $CONTAINER_URL"
